游늶 Prompt de Contexto para Fase 2: Generaci칩n de Contextos y Embeddings MetaCLIP
Situaci칩n del Proyecto: Estamos migrando una arquitectura RAG Multimodal para detecci칩n de defectos vehiculares. Hemos completado la Fase 1 (Generaci칩n de Crops) siguiendo la propuesta de arquitectura docs/RAG_Multimodal_Architexture_Proposal_Clip.md.

El objetivo actual es avanzar a la Fase 2 (Contextualizaci칩n) y Fase 3 (Embeddings), utilizando MetaCLIP 2 (Unified 1024d) sobre un dataset balanceado (50% Da침o / 50% Limpio).

1. Estado Actual: M칩dulos Implementados (Fase 1)
Se han construido y validado tres m칩dulos clave que han generado el dataset de crops en data/processed/crops/balanced_optimized_v2 junto con un metadata_crops_phase1.json:

scripts/phase1_generate_crops_optimized.py (Orquestador):

L칩gica de Diferenciaci칩n: Clasifica im치genes en Damaged o Clean bas치ndose estrictamente en la existencia f칤sica del fichero _labelDANO_modificado.json asociado a la imagen, ignorando nomenclaturas ambiguas.

Carga de Segmentaci칩n: Utiliza un fichero maestro poligonos.json para inyectar la silueta exacta del veh칤culo en el procesado de im치genes limpias.

src/core/preprocessing/clustered_crop_generator_optimized.py (Para Im치genes con Da침o):

Estrategia: Smart Tiling & Context Expansion.

Resoluci칩n: 336x336 px (Nativa para MetaCLIP/ViT-L).

L칩gica:

Si el defecto cabe en 336px: Se centra y expande con contexto real (sin padding gris).

Si el defecto es mayor a 336px: Se aplica tiling (mosaico) con solapamiento para cubrir el defecto sin hacer resize (preservando fidelidad 1:1 del p칤xel).

Output Metadata: Incluye la lista exacta de defectos (defects) contenidos en ese crop espec칤fico.

src/core/preprocessing/grid_crop_generator.py (Para Im치genes Limpias):

Estrategia: Grid sobre m치scara de pol칤gono.

Resoluci칩n: 336x336 px con 30% de overlap.

Filtrado: Descarta crops que contienen mayoritariamente fondo negro (usando la m치scara del poligonos.json), asegurando que solo se procesan texturas de veh칤culo v치lidas.

2. Objetivos Inmediatos (Lo que t칰 debes implementar)
Necesito que contin칰es con la implementaci칩n de la Fase 2: Generaci칩n de Contextos Ricos y la Fase 3: Embeddings Unificados.

A. Generaci칩n de Contextos Textuales (phase2_generate_contexts.py) Debes crear un script que lea metadata_crops_phase1.json y enriquezca cada entrada con un campo text_description.

Referencia Cr칤tica: Debes adaptar la l칩gica de negocio que exist칤a en scripts/03d_generate_hybrid_embeddings_fullimages_dano-nodano.py y src/core/embeddings/multimodal_embedder_v2.py, pero aplicada a nivel de crop.

Reglas de Negocio para el Prompt Textual:

Para Crops CON Da침o:

Usar la lista defects presente en la metadata del crop.

Formato esperado: "{N} {tipo_da침o} on {zona_veh칤culo} ({area}). Specific defects visible: {lista_defectos_crop}."

Debes rescatar el mapeo de zonas y tipos de da침o del config/crop_strategy_config.yaml anterior.

Para Crops SIN Da침o (Clean):

Usar la informaci칩n de vehicle_zone y grid_pos.

Formato esperado: "Clean surface of {zona_veh칤culo} ({area}). No defects visible. Inspection grid section."

Es vital mantener la sem치ntica negativa ("no damage", "clean paint") para que MetaCLIP distinga bien en el espacio vectorial.

B. Generaci칩n de Embeddings MetaCLIP (phase3_generate_metaclip_embeddings.py)

Implementar la clase MetaCLIPUnifiedEmbedder propuesta en docs/RAG_Multimodal_Architexture_Proposal_Clip.md.

Modelo: facebook/metaclip-h14-fullcc2.5b (o equivalente ViT-L/14@336px).

Fusi칩n: Implementar estrategia Average o Weighted de los embeddings de Imagen + Texto (ya alineados en el espacio de 1024d).

Input Visual: Los crops de 336px generados en Fase 1 (sin necesidad de pre-procesado pesado, ya est치n listos).

C. Construcci칩n de 칈ndice FAISS Unificado

Unificar vectores de crops da침ados y limpios en un solo 칤ndice IndexHNSWFlat.

Asegurar que la metadata almacenada permita filtrado por has_damage (bool) y vehicle_zone.

Nota Final: El 칠xito depende de que la descripci칩n textual generada en el paso A sea altamente descriptiva y siga la taxonom칤a del proyecto, ya que MetaCLIP conf칤a en esa alineaci칩n texto-imagen para el retrieval sem치ntico.